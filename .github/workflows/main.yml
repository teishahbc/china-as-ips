name: Update China IPs

on:
  schedule:
    # Run daily at 00:05 UTC to allow time for source databases to potentially update
    - cron: '5 0 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual trigger'
  push:
    branches:
      - main
    paths:
      # Only trigger on push if relevant files change (e.g., script itself)
      # Avoid triggering from the push generated by this workflow itself if only china_ips.txt changes.
      - 'main.py'
      - '.github/workflows/main.yml'

jobs:
  update-ips:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need write permission to push changes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Use latest checkout action

      - name: Set up Python 3.9
        uses: actions/setup-python@v5 # Use latest setup-python action
        with:
          python-version: 3.9

      # No external dependencies needed for the optimized script
      # - name: Install dependencies
      #   run: |
      #     python -m pip install --upgrade pip
      #     # No dependencies needed from pip for the current script

      - name: Download IPinfo Database and Verify
        run: |
          echo "Starting download of IPinfo country_asn database..."
          # Remove potentially old/corrupt file first
          rm -f country_asn.csv.gz
          # Use curl for better error handling and progress (optional)
          # wget -q is fine too, but curl -f fails on server errors (HTTP >= 400)
          curl -f -s -L "https://ipinfo.io/data/free/country_asn.csv.gz?token=${{ secrets.IPINFO_TOKEN }}" -o country_asn.csv.gz
          if [ $? -ne 0 ]; then
            echo "::error::Download failed. Check token or network."
            exit 1
          fi
          echo "Download complete."

          # Verify File Size (Adjust MIN_SIZE based on typical file size)
          # Typical size is > 10MB compressed, let's set a safer minimum like 5MB
          FILE_SIZE=$(stat -c %s country_asn.csv.gz)
          MIN_SIZE=5000000  # 5 Million Bytes (5MB)
          echo "Downloaded file size: $FILE_SIZE bytes."
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo "::error::Downloaded file is too small (size: $FILE_SIZE bytes, minimum expected: $MIN_SIZE bytes). Download may be incomplete or corrupt. Aborting."
            # Optionally: Keep the small file for inspection `ls -l country_asn.csv.gz`
            exit 1
          fi
          echo "File size check passed."
          # Optional: Verify it's a valid gzip file
          if ! gzip -t country_asn.csv.gz; then
             echo "::error::Downloaded file is not a valid gzip file. Aborting."
             exit 1
          fi
          echo "Gzip integrity check passed."

      - name: Run IP Update Script
        run: python main.py

      - name: Commit and Push Changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          # Check if the target file was actually modified
          if ! git diff --quiet ${{ env.OUTPUT_FILE }}; then
            echo "Changes detected in ${{ env.OUTPUT_FILE }}. Committing..."
            git add ${{ env.OUTPUT_FILE }}
            git commit -m "Update China IPs ($(date -u +'%Y-%m-%d'))"
            git push origin main
          else
            echo "No changes detected in ${{ env.OUTPUT_FILE }}. No commit needed."
          fi
        env:
          OUTPUT_FILE: china_ips.txt # Make output file an env variable for consistency
